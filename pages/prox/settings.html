<!DOCTYPE html>
<html lang="en">
  <head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-K8CCSDNPV3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-K8CCSDNPV3');
    </script>
    <meta property="og:title" content="US4 | Settings">
    <meta property="og:description" content="Edit your website settings here!">
    <meta property="og:image" content="/storage/images/logo.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings</title>
    <!-- Favicon for dynamic update -->
    <link rel="icon" href="../storage/images/googleclassroom.png" type="image/png" id="favicon">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link href="/storage/css/settings.css" rel="stylesheet">
    <link href="/storage/css/style.css" rel="stylesheet">
  </head>
  <body>
    <script src="/particles.js"></script>
    <script src="/app.js"></script>
    <div id="particles-js"></div>
    <div class="settings-container">
      <h1>Settings</h1>

      <!-- Background Color Picker -->
      <label for="backgroundColorPicker">Select Background Color:</label>
      <input type="color" id="backgroundColorPicker">

      <!-- Particle Theme Selector -->
      <label for="themeSelector">Select Particle Theme:</label>
      <select id="themeSelector">
        <option value="theme1">Classic White</option>
        <option value="theme2">Neon Triangles</option>
        <option value="theme3">Dark Dust</option>
      </select>

      <!-- Toggles -->
      <div class="checkbox-container">
        <div>
          <label for="beforeUnloadToggle">Anti-Close</label>
          <input type="checkbox" id="beforeUnloadToggle">
        </div>
        <div>
          <label for="autocloakToggle">Auto-about:blank</label>
          <input type="checkbox" id="autocloakToggle">
        </div>
        <div>
          <label for="adsToggle">Ads</label>
          <input type="checkbox" id="adsToggle">
        </div>
      </div>
      <hr>

      <!-- Site Title & Favicon -->
      <label for="siteTitle">Set Site Title:</label>
      <input type="text" id="siteTitle" placeholder="Enter site title">
      <label for="siteLogo">Set Site Favicon:</label>
      <input type="file" id="siteLogo" accept="image/*">
      <button id="saveSettings">Save Title & Favicon</button>
      <hr>

      <!-- Panic Button Settings -->
      <label for="panicKey">Set Panic Button Key:</label>
      <input type="text" id="panicKey" placeholder="Enter key (e.g., F1)">
      <label for="panicUrl">Set Panic Button URL:</label>
      <input type="text" id="panicUrl" placeholder="Enter URL to redirect to">
      <button id="savePanicButtonSettings">Save Panic Button Settings</button>
      <hr>

      <!-- Reset Buttons -->
      <button id="resetSettings" class="reset-button">Reset Tab Name and Icon</button>
      <button id="resetPanicButtonSettings" class="reset-button">Reset Panic Button Settings</button>
    </div>

    <script>
      // Element references
      const backgroundColorPicker = document.getElementById('backgroundColorPicker');
      const themeSelector = document.getElementById('themeSelector');
      const beforeUnloadToggle = document.getElementById('beforeUnloadToggle');
      const autocloakToggle = document.getElementById('autocloakToggle');
      const adsToggle = document.getElementById('adsToggle');
      const siteTitleInput = document.getElementById('siteTitle');
      const siteLogoInput = document.getElementById('siteLogo');
      const saveSettingsButton = document.getElementById('saveSettings');
      const panicKeyInput = document.getElementById('panicKey');
      const panicUrlInput = document.getElementById('panicUrl');
      const savePanicButtonSettingsButton = document.getElementById('savePanicButtonSettings');
      const resetSettingsButton = document.getElementById('resetSettings');
      const resetPanicButtonSettingsButton = document.getElementById('resetPanicButtonSettings');
      const faviconLink = document.getElementById('favicon');

      // Restore settings on load
      function restoreSettings() {
        // Background colour
        const storedColor = localStorage.getItem('backgroundColor') || '#000000';
        document.body.style.backgroundColor = storedColor;
        backgroundColorPicker.value = storedColor;

        // Particle theme
        const storedTheme = localStorage.getItem('particlesTheme') || 'theme1';
        themeSelector.value = storedTheme;
        applyParticleTheme(storedTheme);

        // Toggles
        beforeUnloadToggle.checked = localStorage.getItem('beforeUnloadEnabled') === 'true';
        if (beforeUnloadToggle.checked) window.addEventListener('beforeunload', beforeUnloadHandler);

        autocloakToggle.checked = localStorage.getItem('autocloakEnabled') === 'true';
        adsToggle.checked = localStorage.getItem('Ads') === 'true';

        // Site title
        const savedTitle = localStorage.getItem('siteTitle');
        if (savedTitle) {
          document.title = savedTitle;
          siteTitleInput.value = savedTitle;
        }

        // Favicon
        const savedFavicon = localStorage.getItem('siteLogo');
        if (savedFavicon) faviconLink.href = savedFavicon;

        // Panic settings
        panicKeyInput.value = localStorage.getItem('panicKey') || '';
        panicUrlInput.value = localStorage.getItem('panicUrl') || '';
      }

      // beforeunload handler
      function beforeUnloadHandler(e) { e.preventDefault(); e.returnValue = ''; }

      // Apply particle theme
      function applyParticleTheme(theme) {
        const configPath = `/storage/particles/${theme}.json`;
        if (window.particlesJS) {
          particlesJS.load('particles-js', configPath, function() { console.log('Theme applied:', theme); });
        }
      }

      // Event listeners
      backgroundColorPicker.addEventListener('input', () => {
        document.body.style.backgroundColor = backgroundColorPicker.value;
        localStorage.setItem('backgroundColor', backgroundColorPicker.value);
      });

      themeSelector.addEventListener('change', () => {
        const theme = themeSelector.value;
        localStorage.setItem('particlesTheme', theme);
        applyParticleTheme(theme);
      });

      beforeUnloadToggle.addEventListener('change', () => {
        const enabled = beforeUnloadToggle.checked;
        localStorage.setItem('beforeUnloadEnabled', enabled);
        if (enabled) window.addEventListener('beforeunload', beforeUnloadHandler); else window.removeEventListener('beforeunload', beforeUnloadHandler);
      });

      autocloakToggle.addEventListener('change', () => {
        const enabled = autocloakToggle.checked;
        localStorage.setItem('autocloakEnabled', enabled);
        if (enabled) {
          const newTab = window.open('about:blank', '_blank');
          if (newTab) {
            const iframe = document.createElement('iframe');
            iframe.src = '/'; iframe.style.width = '100vw'; iframe.style.height = '100vh'; iframe.style.border = 'none';
            newTab.document.body.style.margin = '0'; newTab.document.body.appendChild(iframe);
          }
          const panicUrl = localStorage.getItem('panicUrl') || 'https://classroom.google.com';
          window.location.href = panicUrl;
        }
      });

      adsToggle.addEventListener('change', () => {
        localStorage.setItem('Ads', adsToggle.checked);
      });

      siteTitleInput.addEventListener('input', () => {
        const title = siteTitleInput.value.trim() || 'Settings';
        document.title = title;
        if (title !== 'Settings') localStorage.setItem('siteTitle', title); else localStorage.removeItem('siteTitle');
      });
 
      siteLogoInput.addEventListener('change', () => {
        const file = siteLogoInput.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = e => { const url = e.target.result; faviconLink.href = url; localStorage.setItem('siteLogo', url); };
        reader.readAsDataURL(file);
      });

      saveSettingsButton.addEventListener('click', () => {
        // no-op because live updates handle it
      });

      savePanicButtonSettingsButton.addEventListener('click', () => {
        const key = panicKeyInput.value;
        const url = panicUrlInput.value;
        if (key) localStorage.setItem('panicKey', key);
        if (url) localStorage.setItem('panicUrl', url);
      });

      resetSettingsButton.addEventListener('click', () => {
        localStorage.removeItem('siteTitle'); localStorage.removeItem('siteLogo');
        document.title = 'Settings'; faviconLink.href = '../storage/images/googleclassroom.png';
        siteTitleInput.value = ''; siteLogoInput.value = '';
      });

      resetPanicButtonSettingsButton.addEventListener('click', () => {
        localStorage.removeItem('panicKey'); localStorage.removeItem('panicUrl'); panicKeyInput.value = ''; panicUrlInput.value = '';
      });

      window.addEventListener('keydown', e => {
        const key = localStorage.getItem('panicKey'); const url = localStorage.getItem('panicUrl');
        if (e.key === key && url) window.location.href = url;
      });

      // initialise
      restoreSettings();
    </script>

    <script type="text/javascript" src="/storage/js/background.js"></script>
    <script type="text/javascript" src="/storage/js/cheese-algorithm.js"></script>
  </body>
</html>
